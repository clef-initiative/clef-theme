{{/* OpenStreetMap Point of Interest Shortcode using OpenLayers */}}
{{/* Usage: {{< osm lat="52.520008" lng="13.404954" name="Brandenburg Gate" zoom="15" height="400px" >}} */}}

{{ $color := site.Params.color | default "stone" }}
{{ $gray := site.Params.gray | default "stone" }}
{{ $lat := .Get "lat" }}
{{ $lng := .Get "lng" }}
{{ $name := .Get "name" | default "Point of Interest" }}
{{ $zoom := .Get "zoom" | default "15" }}
{{ $height := .Get "height" | default "300px" }}
{{ $width := .Get "width" | default "100%" }}
{{ $mapId := printf "map-%s" now.UnixNano }}

{{ $grayClasses := printf "border border-%s-200 bg-%s-100 text-%s-900 hover:bg-%s-50 dark:bg-%s-800 dark:text-%s-100 dark:hover:bg-%s-600" $gray $gray $gray $gray $gray $gray $gray }}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

<!-- Map container -->
<div class="rounded-xl overflow-hidden  w-full max-w-none h-64">
  <div id="{{ $mapId }}" style="width: 100%; height: 100%"></div>
</div>

<script>
(function() {
  // Convert coordinates to numbers
  const lat = parseFloat({{ $lat }});
  const lng = parseFloat({{ $lng }});
  const zoom = parseInt({{ $zoom }});

  if (isNaN(lat) || isNaN(lng)) {
    console.error('Invalid coordinates provided to OSM shortcode');
    return;
  }

  // Transform coordinates from EPSG:4326 to EPSG:3857 (Web Mercator)
  const coordinates = ol.proj.fromLonLat([lng, lat]);

  // Create the map
  const map = new ol.Map({
    target: '{{ $mapId }}',
    layers: [
      // OpenStreetMap layer
      // CartoDB light minimal style
      new ol.layer.Tile({
        source: new ol.source.OSM({
          url: 'https://{a-d}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png'
        })
      })
    ],
    view: new ol.View({
      center: coordinates,
      zoom: zoom
    }),
    controls: [
      new ol.control.Attribution(),
      new ol.control.Zoom()
    ]
  });

  // Create a marker for the point of interest
  const marker = new ol.Feature({
    geometry: new ol.geom.Point(coordinates),
    name: {{ $name | jsonify }}
  });

  // Style for the marker
  const markerStyle = new ol.style.Style({
    image: new ol.style.Icon({
      anchor: [0.5, 1],
      src: 'data:image/svg+xml;base64,' + btoa(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="#EA102B" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          <path fill="white" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
        </svg>
      `)
    })
  });

  marker.setStyle(markerStyle);

  // Create vector source and layer for the marker
  const vectorSource = new ol.source.Vector({
    features: [marker]
  });

  const vectorLayer = new ol.layer.Vector({
    source: vectorSource
  });

  // Add the marker layer to the map
  map.addLayer(vectorLayer);

  // Optional: Add click event to show popup with POI name
  {{ if $name }}
  const popup = new ol.Overlay({
    element: document.createElement('div'),
    positioning: 'bottom-center',
    stopEvent: false,
    offset: [0, -24]
  });

  popup.getElement().innerHTML = `
    <div class="px-2 py-1 rounded-lg text-xs font-light {{ $grayClasses }} border-2">
      {{ $name }}
    </div>
  `;

  map.addOverlay(popup);
  popup.setPosition(coordinates);
  {{ end }}

})();
</script>