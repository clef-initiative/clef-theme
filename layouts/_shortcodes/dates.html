{{/* layouts/shortcodes/dates.html */}}
{{ $color := .Site.Params.color | default "stone" }}
{{ $gray := .Site.Params.gray | default "stone" }}
{{ $key := .Get "key" | default "all" }}
{{ $past := .Get "past" | default "strike" }}
{{ $dateData := dict }}
{{ if eq $key "all" }}
  {{ $mergedDates := slice }}
  {{ range .Site.Data.dates }}
    {{ range .dates }}
      {{ $mergedDates = $mergedDates | append . }}
    {{ end }}
  {{ end }}
  {{ $sortedDates := sort $mergedDates "date" }}
  {{ $dateData = dict "dates" $sortedDates }}
{{ else }}
  {{ $originalData := index .Site.Data.dates $key }}
  {{ $sortedDates := sort $originalData.dates "date" }}
  {{ $dateData = dict "dates" $sortedDates "timezone" $originalData.timezone }}
{{ end }}

{{ if $dateData }}
  <!-- Dates table component -->
  <div class="overflow-hidden max-w-full rounded-xl border border-{{ $gray }}-200 dark:border-{{ $gray }}-700 bg-{{ $gray }}-50 dark:bg-{{ $gray }}-800" data-dates-table data-past-mode="{{ $past }}" data-gray="{{ $gray }}">

    <!-- Table container -->
    <div class="overflow-x-auto">
      <table class="min-w-full mt-1 mb-0">

        <!-- Table header -->
        <thead>
          <tr  class="py-1">
            <th scope="col" class="p-2 text-left font-semibold text-{{ $gray }}-600 dark:text-{{ $gray }}-400 uppercase tracking-wider">
              Event
            </th>
            <th scope="col" class="p-2 text-left font-semibold text-{{ $gray }}-600 dark:text-{{ $gray }}-400 uppercase tracking-wider">
              Date
            </th>
            <th scope="col" class="p-2 text-left font-semibold text-{{ $gray }}-600 dark:text-{{ $gray }}-400 uppercase tracking-wider">
              Status
            </th>
          </tr>
        </thead>

        <!-- Table body -->
        <tbody class="">
          {{ range $index, $item := $dateData.dates }}
            {{ $eventDate := time $item.date }}

            <tr data-date="{{ $item.date }}" class="hover:bg-{{ $gray }}-100 dark:hover:bg-{{ $gray }}-700 transition-colors">

              <!-- Event name -->
              <td class="p-2 whitespace-nowrap">
                <div class="event-name text-{{ $gray }}-900 dark:text-{{ $gray }}-100">
                  {{ $item.name }}
                </div>
              </td>

              <!-- Event date -->
              <td class="p-2 whitespace-nowrap">
                <time datetime="{{ $item.date }}" class="event-date text-{{ $gray }}-700 dark:text-{{ $gray }}-300">
                  {{ $eventDate.Format "January 2, 2006" }}
                </time>
              </td>

              <!-- Event status -->
              <td class="p-2 whitespace-nowrap">
                <span class="event-status inline-flex items-center px-3 py-1 rounded-xl">
                  <!-- Updated by JavaScript -->
                </span>
              </td>

            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>

    <!-- Timezone note -->
    {{ if $dateData.timezone }}
    <div class="border-t border-{{ $gray }}-200 dark:border-{{ $gray }}-700 p-2 bg-{{ $gray }}-50 dark:bg-{{ $gray }}-800">
      <span class="text-sm text-{{ $gray }}-600 dark:text-{{ $gray }}-400">
        All times are in {{ $dateData.timezone }} timezone.
      </span>
    </div>
    {{ end }}

  </div>

  <!-- Client-side date calculation script -->
  <script>
    (function() {
      function updateDateStatuses() {
        const tables = document.querySelectorAll('[data-dates-table]');

        tables.forEach(table => {
          const pastMode = table.dataset.pastMode;
          const gray = table.dataset.gray;
          const rows = table.querySelectorAll('tbody tr[data-date]');

          rows.forEach(row => {
            const dateStr = row.dataset.date;
            const eventDate = new Date(dateStr + 'T23:59:59Z'); // End of day in UTC (AoE compatible)
            const now = new Date();

            // Calculate days difference
            const msPerDay = 24 * 60 * 60 * 1000;
            const daysDiff = Math.floor((eventDate - now) / msPerDay);

            const isPast = daysDiff < 0;
            const isFuture = daysDiff > 0;
            const isToday = daysDiff === 0;

            const eventName = row.querySelector('.event-name');
            const eventDateEl = row.querySelector('.event-date');
            const statusEl = row.querySelector('.event-status');

            // Handle past dates styling based on pastMode
            if (isPast && pastMode === 'omit') {
              row.style.display = 'none';
              return;
            }

            if (isPast && pastMode === 'strike') {
              row.classList.add('opacity-60');
              eventName.classList.add('line-through');
              eventDateEl.classList.add('line-through');
            } else {
              row.classList.remove('opacity-60');
              eventName.classList.remove('line-through');
              eventDateEl.classList.remove('line-through');
            }

            // Update status badge
            if (isFuture) {
              const dayText = daysDiff === 1 ? ' day' : ' days';
              statusEl.textContent = daysDiff + dayText;
              statusEl.className = 'event-status inline-flex items-center px-3 py-1 rounded-xl bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100';
            } else if (isPast) {
              statusEl.textContent = 'Passed';
              statusEl.className = 'event-status inline-flex items-center px-3 py-1 rounded-xl bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100';
            } else {
              statusEl.textContent = 'Today';
              statusEl.className = 'event-status inline-flex items-center px-3 py-1 rounded-xl bg-yellow-100 text-yellow-800 dark:bg-yellow-400 dark:text-yellow-900';
            }
          });
        });
      }

      // Update on page load
      updateDateStatuses();

      // Update daily at midnight
      const now = new Date();
      const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      const msUntilMidnight = tomorrow - now;

      setTimeout(function() {
        updateDateStatuses();
        // Then update every 24 hours
        setInterval(updateDateStatuses, 24 * 60 * 60 * 1000);
      }, msUntilMidnight);
    })();
  </script>
{{ else }}
  <!-- Error state using alert pattern -->
  <div class="w-full px-4 py-4 rounded-xl border border-red-200 bg-red-50 text-red-800 dark:border-red-700 dark:bg-red-900 dark:text-red-200" role="alert" aria-live="polite">
    <div class="flex gap-3">

      <!-- Error icon -->
      <div class="flex-shrink-0 pt-0.5">
        <div class="h-5 w-5 text-red-500 dark:text-red-400" aria-hidden="true">
          <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='currentColor'>
            <path stroke-linecap='round' stroke-linejoin='round' d='M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z' />
          </svg>
        </div>
      </div>

      <!-- Error content -->
      <div class="flex-1 space-y-2">
        <div class="font-semibold leading-tight">
          Data not found
        </div>
        <div class="text-sm leading-relaxed">
          No dates found for key "{{ $key }}". Please check your data file and key name.
        </div>
      </div>

    </div>
  </div>
{{ end }}